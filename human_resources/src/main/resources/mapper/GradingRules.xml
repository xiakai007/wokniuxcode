<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.isoftstone.humanresources.dao.GradingRulesDao">
	<!-- 新增项目经理画像比分规则 -->
	<insert id="addGradingRules"
		parameterType="com.isoftstone.humanresources.domain.portraitprojectmanager.GradingRulesVO">
		INSERT INTO T_SCORE_WEIGHTING_TAB
		(
		scoreType,
		scoreProportion,
		createTime,
		createemployeeID,
		BU,
		BD,
		bak
		)
		values
		<foreach collection="gradingRules.ruleList" item="item" index="index"
			separator=",">
			(
			#{item.scoreType},
			#{item.scoreProportion},
			now(),
			#{gradingRules.createemployeeID},
			#{gradingRules.bu},
			#{gradingRules.bd},
			#{gradingRules.bak}
			)
		</foreach>
	</insert>

	<!-- 修改项目经理画像比分规则 -->
	<update id="updateGradingRules"
		parameterType="com.isoftstone.humanresources.domain.portraitprojectmanager.GradingRulesVO">
		update
		T_SCORE_WEIGHTING_TAB
		<trim prefix="set" suffixOverrides=",">
			<trim prefix="scoreProportion =case" suffix="end,">
				<foreach collection="gradingRules.ruleList" item="item"
					index="index">
					when
					scoreType = #{item.scoreType}
					then #{item.scoreProportion}
				</foreach>
			</trim>
			<trim prefix="updateTime =case" suffix="end,">
				<foreach collection="gradingRules.ruleList" item="item"
					index="index">
					when
					scoreType = #{item.scoreType}
					then now()
				</foreach>
			</trim>
			<trim prefix="updateEmployeeID =case" suffix="end,">
				<foreach collection="gradingRules.ruleList" item="item"
					index="index">
					when
					scoreType = #{item.scoreType}
					then
					#{gradingRules.updateEmployeeID}
				</foreach>
			</trim>
			<trim prefix="bak =case" suffix="end,">
				<foreach collection="gradingRules.ruleList" item="item"
					index="index">
					when
					scoreType = #{item.scoreType}
					then #{gradingRules.bak}
				</foreach>
			</trim>
		</trim>
		where 1 = 1
		<if test="gradingRules.bu != null and gradingRules.bu != ''">and bu = #{gradingRules.bu}</if>
		<if test="gradingRules.bd != null and gradingRules.bd != ''">and bd = #{gradingRules.bd}</if>
	</update>

	<!--校验规则新增接口 -->
	<select id="queryRuleCount" parameterType="String" resultType="int">
		SELECT
		count(1)
		FROM T_SCORE_WEIGHTING_TAB
		WHERE
		BU = #{bdOrBu} OR BD = #{bdOrBu};
	</select>

	<!-- 查询比分规则详情 -->
	<select id="queryRuleInfo" parameterType="String"
		resultType="com.isoftstone.humanresources.domain.GradingRulesInformation">
		SELECT
		ts.scoreType,
		tc.configValue as scoreName,
		ts.scoreProportion,
		ts.createTime,
		ts.updateTime,
		ts.BU,
		t2.organizationName as buName,
		ts.BD,
		t1.organizationName as bdName,
		ts.bak,
		ts.createemployeeID,
		t3.employeeName as createName,
		ts.updateEmployeeID,
		t4.employeeName as updateName
		FROM
		t_score_weighting_tab ts
		INNER JOIN t_system_config tc
		ON ts.scoreType = tc.configName
		LEFT JOIN t_organization t1
		ON ts.BD = t1.organizationID
		LEFT JOIN t_organization t2
		ON ts.BU = t2.organizationID
		LEFT JOIN t_employee t3 ON
		ts.createemployeeID = t3.employeeID
		LEFT JOIN t_employee t4 ON
		ts.updateEmployeeID = t4.employeeID
		WHERE
		ts.${orgType} = #{bdOrBu}
	</select>
	<select id="queryParent" parameterType="String" resultType="String">
	select parentID from t_organization where organizationID = #{organzationId}
	</select>
</mapper>